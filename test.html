<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Opname Validation Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .legend {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }
        .legend h3 {
            margin-top: 0;
            color: #2d3748;
        }
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-box {
            width: 40px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #333;
        }
        .success { background: #48bb78; }
        .error { background: #f56565; }
        .warning { background: #ed8936; }
        .info { background: #4299e1; }
        .process { background: #9f7aea; }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        .notes {
            background: #fffbeb;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            border-left: 4px solid #ed8936;
        }
        .notes h3 {
            margin-top: 0;
            color: #744210;
        }
        .notes ul {
            color: #744210;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Stock Opname Label Validation</h1>
        <p class="subtitle">Comprehensive Flowchart - PPS System</p>
        
        <div class="legend">
            <h3>ðŸŽ¨ Legend</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-box success"></div>
                    <span>Success Response</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box error"></div>
                    <span>Error/Invalid</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box warning"></div>
                    <span>Warning/Discrepancy</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box info"></div>
                    <span>Information Check</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box process"></div>
                    <span>Process/Query</span>
                </div>
            </div>
        </div>

        <div class="mermaid">
graph TD
    Start([START<br/>validateStockOpnameLabel]) --> CheckLabel{Label<br/>Provided?}
    
    CheckLabel -->|No| ErrNoLabel[RETURN ERROR<br/>Label wajib diisi]
    CheckLabel -->|Yes| ValidateFormat{Validate Format<br/>10 Categories}
    
    ValidateFormat -->|Invalid| ErrFormat[RETURN ERROR<br/>Kode label tidak dikenali]
    ValidateFormat -->|Valid| ParseLabel[Parse Label<br/>Extract Parameters]
    
    ParseLabel --> CheckDuplicate[Query: Check Duplicate<br/>StockOpnameHasil Table]
    
    CheckDuplicate --> IsDuplicate{Is<br/>Duplicate?}
    
    IsDuplicate -->|Yes| ErrDuplicate[RETURN ERROR<br/>Label telah discan<br/>isDuplicate=true]
    
    IsDuplicate -->|No| CheckSOQualification[Query: SO Qualification<br/>StockOpname_h]
    
    CheckSOQualification --> CategoryMatch{Category<br/>Matches SO?}
    
    CategoryMatch -->|No| GetOriginalData1[Query: Original Data<br/>All records including used]
    GetOriginalData1 --> ErrCategory[RETURN ERROR<br/>Kategori tidak sesuai<br/>isValidCategory=false]
    
    CategoryMatch -->|Yes| GetWarehouse[Query: Get IdWarehouse<br/>From MstBlok join]
    
    GetWarehouse --> CheckWarehouse[Query: Validate Warehouse<br/>StockOpname_h_WarehouseID]
    
    CheckWarehouse --> QueryDetail[Query: DETAIL QUERY<br/>DateUsage IS NULL<br/>EXISTS in SO kategori]
    
    QueryDetail --> DetailFound{Data<br/>Found?}
    
    DetailFound -->|Yes| ValidateWH{Warehouse<br/>Valid?}
    
    ValidateWH -->|No| ErrWarehouse[RETURN ERROR<br/>Warehouse tidak sesuai<br/>idDiscrepancy=2]
    
    ValidateWH -->|Yes| CheckLocationMatch{Blok and<br/>IdLokasi<br/>Match?}
    
    CheckLocationMatch -->|No| WarnLocationMoved[RETURN SUCCESS<br/>Lokasi dipindahkan<br/>foundInStockOpname=true]
    
    CheckLocationMatch -->|Yes| SuccessValid[RETURN SUCCESS<br/>Label Valid<br/>foundInStockOpname=true]
    
    DetailFound -->|No| QueryFallback[Query: FALLBACK QUERY<br/>DateUsage IS NULL<br/>NO SO qualification check]
    
    QueryFallback --> FallbackFound{Data Found<br/>and Has Stock?}
    
    FallbackFound -->|Yes| WarnNotInSO[RETURN SUCCESS<br/>Label tidak masuk daftar SO<br/>idDiscrepancy=2]
    
    FallbackFound -->|No| QueryOriginal[Query: ORIGINAL DATA<br/>All records<br/>including DateUsage]
    
    QueryOriginal --> OriginalFound{Data Found<br/>and Has Stock?}
    
    OriginalFound -->|Yes| ErrProcessed[RETURN ERROR<br/>Item telah diproses<br/>idDiscrepancy=1]
    
    OriginalFound -->|No| ErrNotFound[RETURN ERROR<br/>Item tidak ditemukan<br/>idDiscrepancy=1]
    
    style Start fill:#667eea,stroke:#333,stroke-width:3px,color:#fff
    style ErrNoLabel fill:#f56565,stroke:#333,stroke-width:2px,color:#fff
    style ErrFormat fill:#f56565,stroke:#333,stroke-width:2px,color:#fff
    style ErrDuplicate fill:#f56565,stroke:#333,stroke-width:2px,color:#fff
    style ErrCategory fill:#f56565,stroke:#333,stroke-width:2px,color:#fff
    style ErrWarehouse fill:#f56565,stroke:#333,stroke-width:2px,color:#fff
    style ErrProcessed fill:#f56565,stroke:#333,stroke-width:2px,color:#fff
    style ErrNotFound fill:#f56565,stroke:#333,stroke-width:2px,color:#fff
    
    style SuccessValid fill:#48bb78,stroke:#333,stroke-width:2px,color:#fff
    style WarnLocationMoved fill:#ed8936,stroke:#333,stroke-width:2px,color:#fff
    style WarnNotInSO fill:#ed8936,stroke:#333,stroke-width:2px,color:#fff
    
    style CheckDuplicate fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    style CheckSOQualification fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    style GetWarehouse fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    style CheckWarehouse fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    style QueryDetail fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    style QueryFallback fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    style QueryOriginal fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    style GetOriginalData1 fill:#9f7aea,stroke:#333,stroke-width:2px,color:#fff
    
    style ValidateFormat fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
    style IsDuplicate fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
    style CategoryMatch fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
    style DetailFound fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
    style ValidateWH fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
    style CheckLocationMatch fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
    style FallbackFound fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
    style OriginalFound fill:#4299e1,stroke:#333,stroke-width:2px,color:#fff
        </div>

        <div class="notes">
            <h3>ðŸ“Œ Important Notes</h3>
            <ul>
                <li><strong>3-Level Query Priority:</strong>
                    <ol>
                        <li><strong>Detail Query:</strong> DateUsage IS NULL + EXISTS in SO â†’ "Label Valid"</li>
                        <li><strong>Fallback Query:</strong> DateUsage IS NULL only â†’ "Tidak masuk daftar SO" (idDiscrepancy=2)</li>
                        <li><strong>Original Data:</strong> All records â†’ "Telah diproses" (idDiscrepancy=1)</li>
                    </ol>
                </li>
                <li><strong>Location Mismatch Check:</strong> Compares controller's Blok/IdLokasi with database. If different, returns success with warning message "Lokasi dipindahkan".</li>
                <li><strong>Partial Calculation:</strong> For items with IsPartial=1, calculates: <code>Berat - TotalPartial</code> from PartialTable.</li>
                <li><strong>Bonggolan Special:</strong> Includes mesinInfo array with machine/operator details from multiple production sources.</li>
                <li><strong>idDiscrepancy Values:</strong>
                    <ul>
                        <li><code>null</code> = No issues</li>
                        <li><code>1</code> = Item processed/not found</li>
                        <li><code>2</code> = Item exists but not in SO list or wrong warehouse</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            }
        });
    </script>
</body>
</html>